<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>IOC Checker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="section">
<div class="container">
    <h1 class="title">IOC Checker</h1>
    <textarea id="raw-input" class="textarea" placeholder="Paste text containing IOCs"></textarea>
    <button class="button is-primary mt-2" onclick="parseIOCs()">Parse</button>
    <div class="file has-name mt-4">
        <label class="file-label">
            <input class="file-input" type="file" id="file-input" accept=".txt,.log,.csv,.json">
            <span class="file-cta">
                <span class="file-label">Choose a fileâ€¦</span>
            </span>
            <span class="file-name" id="file-name"></span>
        </label>
    </div>
    <button class="button is-primary mt-2" onclick="parseFile()">Parse File</button>
    <div id="parsed" class="columns mt-4"></div>
    <button class="button is-link mt-2" onclick="submitScans()">Scan Parsed IOCs</button>
    <div id="results" class="mt-4"></div>
</div>
<script>
function displayParsed(data){
    const container = document.getElementById('parsed');
    container.innerHTML = '';
    Object.keys(data).forEach(key => {
        const col = document.createElement('div');
        col.className = 'column';
        const label = document.createElement('label');
        label.className = 'label';
        label.textContent = key;
        const ta = document.createElement('textarea');
        ta.id = 'parsed-' + key;
        ta.className = 'textarea';
        ta.value = data[key].join('\n');
        col.appendChild(label);
        col.appendChild(ta);
        container.appendChild(col);
    });
}

async function parseIOCs(){
    const raw = document.getElementById('raw-input').value;
    const res = await fetch('/parse', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({text: raw})});
    const data = await res.json();
    displayParsed(data);
}

async function parseFile(){
    const fileInput = document.getElementById('file-input');
    if(!fileInput.files.length) return;
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    const res = await fetch('/parse-file', {method:'POST', body: formData});
    const data = await res.json();
    displayParsed(data);
}

document.getElementById('file-input').addEventListener('change', () => {
    const fileInput = document.getElementById('file-input');
    const fileName = document.getElementById('file-name');
    if(fileInput.files.length){
        fileName.textContent = fileInput.files[0].name;
    } else {
        fileName.textContent = '';
    }
});
async function submitScans(){
    const areas = document.querySelectorAll('[id^="parsed-"]');
    let iocs = [];
    areas.forEach(a => {
        const vals = a.value.trim().split(/\n+/).filter(Boolean);
        iocs = iocs.concat(vals);
    });
    if(!iocs.length) return;
    const res = await fetch('/scan', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({service: 'virustotal', iocs})});
    const data = await res.json();
    const container = document.getElementById('results');
    container.innerHTML = '';
    data.tasks.forEach(t => {
        const div = document.createElement('div');
        div.id = 'task-' + t.id;
        div.innerHTML = `<span class="icon"><i class="fas fa-spinner fa-spin"></i></span> ${t.ioc} : queued`;
        container.appendChild(div);
        poll(t.id, div);
    });
}
async function poll(id, element){
    const res = await fetch(`/status/${id}`);
    const data = await res.json();
    if(data.status){
        if(data.status === 'queued' || data.status === 'processing'){
            element.innerHTML = `<span class="icon"><i class="fas fa-spinner fa-spin"></i></span> ${data.ioc} : ${data.status}`;
            setTimeout(()=>poll(id, element), 1000);
        } else if(data.status === 'done'){
            const stats = data.result.last_analysis_stats || {};
            const total = Object.values(stats).reduce((a,b)=>a+b,0);
            const malicious = stats.malicious || 0;
            const tags = data.result.tags && data.result.tags.length ? ` <span class="icon"><i class="fas fa-tags"></i></span> ${data.result.tags.join(', ')}` : '';
            element.innerHTML = `<span class="icon has-text-success"><i class="fas fa-check"></i></span> ${data.ioc} : rep ${data.result.reputation}, ${malicious}/${total} detections${tags}`;
        } else if(data.status === 'error'){
            element.innerHTML = `<span class="icon has-text-danger"><i class="fas fa-exclamation-triangle"></i></span> ${data.ioc} : error ${data.error}`;
        }
    }
}
</script>
</body>
</html>
