<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>IOC Checker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulmaswatch@0.8.1/darkly/bulmaswatch.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        html, body {
            height: 100%;
        }

        body {
            padding: 1rem;
        }

        #app-columns {
            height: calc(100vh - 2rem);
        }

        #input-column {
            flex: 0 0 30%;
            max-width: 30%;
            padding: 1rem;
            overflow-y: auto;
            background-color: #1e1e1e;
            border-right: 1px solid #2e2e2e;
        }

        #ioc-columns {
            flex: 0 0 70%;
            max-width: 70%;
            padding: 1rem;
            overflow-y: auto;
            background-color: #181818;
        }

        textarea.textarea {
            background-color: #2b2b2b;
            color: #f5f5f5;
            border-color: #444;
        }

        textarea.textarea:focus {
            border-color: #7957d5;
            box-shadow: 0 0 0 0.125em rgba(121, 87, 213, 0.25);
        }

        textarea.textarea::placeholder {
            color: #7a7a7a;
        }
    </style>
</head>
<body class="has-background-dark has-text-light">
<div class="columns is-gapless" id="app-columns">
    <div class="column" id="input-column">
        <h1 class="title has-text-light">IOC Checker</h1>
        <div class="field">
            <div class="control">
                <button class="button is-primary" id="upload-btn">
                    <span class="icon"><i class="fas fa-upload"></i></span>
                    <span>Upload file</span>
                </button>
                <input class="is-hidden" type="file" id="file-input" accept=".txt,.log,.csv,.json">
            </div>
        </div>
        <div class="field">
            <div class="control">
                <textarea id="raw-input" class="textarea" placeholder="Paste text containing IOCs"></textarea>
            </div>
        </div>
        <div class="field">
            <label class="label has-text-light">Provider</label>
            <div class="control">
                <div class="select is-fullwidth">
                    <select id="provider">
                        {% for p in providers %}
                        <option value="{{p}}">{{p}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <div class="field is-grouped">
            <div class="control">
                <button class="button is-link" id="scan-all">Scan all</button>
            </div>
            <div class="control">
                <button class="button" id="copy-malicious">Copy malicious</button>
            </div>
        </div>
    </div>
    <div class="column" id="ioc-columns"></div>
</div>

<script>
let parsedData = {};

document.getElementById('provider').addEventListener('change', renderParsed);

const fileInput = document.getElementById('file-input');
document.getElementById('upload-btn').addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', () => {
    if (!fileInput.files.length) return;
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    fetch('/parse-file', {method:'POST', body: formData})
        .then(r => r.json())
        .then(data => { parsedData = data; renderParsed(); });
});

let debounceTimer;
document.getElementById('raw-input').addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
        const text = document.getElementById('raw-input').value;
        fetch('/parse', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({text})})
            .then(r => r.json())
            .then(data => { parsedData = data; renderParsed(); });
    }, 300);
});

function renderParsed(){
    const container = document.getElementById('ioc-columns');
    container.innerHTML = '';
    Object.entries(parsedData).forEach(([kind, values]) => {
        if(!['ipv4','fqdn','md5','sha1','sha256'].includes(kind)) return;
        const box = document.createElement('div');
        box.className = 'box';
        const title = document.createElement('h3');
        title.className = 'subtitle';
        title.textContent = kind;
        box.appendChild(title);
        const list = document.createElement('div');
        const provider = document.getElementById('provider').value;
        values.forEach(val => {
            const item = document.createElement('div');
            item.className = 'ioc-item';
            const link = document.createElement('a');
            link.href = iocLink(provider, kind, val);
            link.target = '_blank';
            link.textContent = val;
            item.appendChild(link);
            const status = document.createElement('span');
            status.className = 'status ml-2';
            item.appendChild(status);
            list.appendChild(item);
        });
        box.appendChild(list);
        const btn = document.createElement('button');
        btn.className = 'button is-small is-link mt-2';
        btn.textContent = 'Scan';
        btn.addEventListener('click', () => scan(values));
        box.appendChild(btn);
        container.appendChild(box);
    });
}

function iocLink(provider, kind, value){
    if(provider === 'kaspersky'){
        return `https://opentip.kaspersky.com/${value}`;
    }
    if(kind === 'ipv4') return `https://www.virustotal.com/gui/ip-address/${value}`;
    if(kind === 'fqdn') return `https://www.virustotal.com/gui/domain/${value}`;
    return `https://www.virustotal.com/gui/file/${value}`;
}

function scan(iocs){
    if(!iocs.length) return;
    const service = document.getElementById('provider').value;
    fetch('/scan', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({service, iocs})})
        .then(r => r.json())
        .then(data => {
            data.tasks.forEach(t => {
                const elem = [...document.querySelectorAll('.ioc-item')].find(div => div.firstChild.textContent === t.ioc);
                if(elem) poll(t.id, elem.querySelector('.status'));
            });
        });
}

document.getElementById('scan-all').addEventListener('click', () => {
    const all = [];
    Object.entries(parsedData).forEach(([kind, vals]) => {
        if(['ipv4','fqdn','md5','sha1','sha256'].includes(kind)) all.push(...vals);
    });
    scan(all);
});

document.getElementById('copy-malicious').addEventListener('click', () => {
    const mal = [...document.querySelectorAll('.status[data-malicious="true"]')]
        .map(s => s.parentElement.querySelector('a').textContent);
    if(mal.length) navigator.clipboard.writeText(mal.join('\n'));
});

function poll(id, statusElem){
    fetch(`/status/${id}`).then(r => r.json()).then(data => {
        if(data.status === 'queued' || data.status === 'processing'){
            statusElem.innerHTML = '<span class="icon"><i class="fas fa-spinner fa-spin"></i></span>';
            setTimeout(() => poll(id, statusElem), 1000);
        }else if(data.status === 'done'){
            if(data.service === 'kaspersky'){
                const info = data.result || {};
                if(info.status_code !== 200){
                    statusElem.innerHTML = `<span class="icon has-text-danger"><i class="fas fa-exclamation-triangle"></i></span> ${info.error || 'error'}`;
                    return;
                }
                const res = info.data || {};
                let text = `zone ${res.zone || 'unknown'}`;
                if(res.status) text += `, status ${res.status}`;
                if(typeof res.hits_count === 'number') text += `, hits ${res.hits_count}`;
                if(res.categories && res.categories.length) text += `, categories ${res.categories.join(', ')}`;
                if(res.zone && res.zone.toLowerCase() !== 'green') statusElem.dataset.malicious = 'true';
                statusElem.innerHTML = `<span class="icon has-text-success"><i class="fas fa-check"></i></span> ${text}`;
            }else{
                const stats = data.result.last_analysis_stats || {};
                const total = Object.values(stats).reduce((a,b)=>a+b,0);
                const mal = stats.malicious || 0;
                const tags = data.result.tags && data.result.tags.length ? ` <span class="icon"><i class="fas fa-tags"></i></span> ${data.result.tags.join(', ')}` : '';
                if(mal > 0) statusElem.dataset.malicious = 'true';
                statusElem.innerHTML = `<span class="icon has-text-success"><i class="fas fa-check"></i></span> rep ${data.result.reputation}, ${mal}/${total} detections${tags}`;
            }
        }else if(data.status === 'error'){
            statusElem.innerHTML = `<span class="icon has-text-danger"><i class="fas fa-exclamation-triangle"></i></span> error`;
        }
    });
}
</script>
</body>
</html>
