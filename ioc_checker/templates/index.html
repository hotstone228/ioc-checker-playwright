<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>IOC Checker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="section" id="body">
<div class="container is-fluid">
    <div class="level">
        <div class="level-left"><h1 class="title">IOC Checker</h1></div>
        <div class="level-right">
            <button class="button is-small" id="theme-toggle"><span class="icon"><i class="fas fa-moon"></i></span></button>
        </div>
    </div>
    <div class="columns" id="main-columns">
        <div class="column" id="left-column" style="flex:0 0 30%;max-width:30%">
            <div class="field">
                <div class="control">
                    <button class="button is-primary" id="upload-btn">
                        <span class="icon"><i class="fas fa-upload"></i></span>
                        <span>Upload file</span>
                    </button>
                    <input class="is-hidden" type="file" id="file-input" accept=".txt,.log,.csv,.json">
                </div>
            </div>
            <div class="field">
                <div class="control">
                    <textarea id="raw-input" class="textarea" placeholder="Paste text containing IOCs"></textarea>
                </div>
            </div>
            <div class="field is-grouped">
                <div class="control">
                    <button class="button is-link" id="scan-all">Scan all</button>
                </div>
                <div class="control">
                    <button class="button" id="copy-malicious">Copy malicious</button>
                </div>
            </div>
        </div>
        <div class="column" id="ioc-columns" style="flex:0 0 70%;max-width:70%"></div>
    </div>
</div>

<style>
body.dark { background-color:#222; color:#f5f5f5; }
body.dark .box { background-color:#2b2b2b; color:#f5f5f5; }
body.dark .textarea { background-color:#2b2b2b; color:#f5f5f5; }
</style>

<script>
let parsedData = {};

const fileInput = document.getElementById('file-input');
document.getElementById('upload-btn').addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', () => {
    if (!fileInput.files.length) return;
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    fetch('/parse-file', {method:'POST', body: formData})
        .then(r => r.json())
        .then(data => { parsedData = data; renderParsed(); });
});

let debounceTimer;
document.getElementById('raw-input').addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
        const text = document.getElementById('raw-input').value;
        fetch('/parse', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({text})})
            .then(r => r.json())
            .then(data => { parsedData = data; renderParsed(); });
    }, 300);
});

function renderParsed(){
    const container = document.getElementById('ioc-columns');
    container.innerHTML = '';
    Object.entries(parsedData).forEach(([kind, values]) => {
        if(!['ipv4','fqdn','md5','sha1','sha256'].includes(kind)) return;
        const box = document.createElement('div');
        box.className = 'box';
        const title = document.createElement('h3');
        title.className = 'subtitle';
        title.textContent = kind;
        box.appendChild(title);
        const list = document.createElement('div');
        values.forEach(val => {
            const item = document.createElement('div');
            item.className = 'ioc-item';
            const link = document.createElement('a');
            link.href = vtLink(kind,val);
            link.target = '_blank';
            link.textContent = val;
            item.appendChild(link);
            const status = document.createElement('span');
            status.className = 'status ml-2';
            item.appendChild(status);
            list.appendChild(item);
        });
        box.appendChild(list);
        const btn = document.createElement('button');
        btn.className = 'button is-small is-link mt-2';
        btn.textContent = 'Scan';
        btn.addEventListener('click', () => scan(values));
        box.appendChild(btn);
        container.appendChild(box);
    });
}

function vtLink(kind, value){
    if(kind === 'ipv4') return `https://www.virustotal.com/gui/ip-address/${value}`;
    if(kind === 'fqdn') return `https://www.virustotal.com/gui/domain/${value}`;
    return `https://www.virustotal.com/gui/file/${value}`;
}

function scan(iocs){
    if(!iocs.length) return;
    fetch('/scan', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({service:'virustotal', iocs})})
        .then(r => r.json())
        .then(data => {
            data.tasks.forEach(t => {
                const elem = [...document.querySelectorAll('.ioc-item')].find(div => div.firstChild.textContent === t.ioc);
                if(elem) poll(t.id, elem.querySelector('.status'));
            });
        });
}

document.getElementById('scan-all').addEventListener('click', () => {
    const all = [];
    Object.entries(parsedData).forEach(([kind, vals]) => {
        if(['ipv4','fqdn','md5','sha1','sha256'].includes(kind)) all.push(...vals);
    });
    scan(all);
});

document.getElementById('copy-malicious').addEventListener('click', () => {
    const mal = [...document.querySelectorAll('.status[data-malicious="true"]')]
        .map(s => s.parentElement.querySelector('a').textContent);
    if(mal.length) navigator.clipboard.writeText(mal.join('\n'));
});

function poll(id, statusElem){
    fetch(`/status/${id}`).then(r => r.json()).then(data => {
        if(data.status === 'queued' || data.status === 'processing'){
            statusElem.innerHTML = '<span class="icon"><i class="fas fa-spinner fa-spin"></i></span>';
            setTimeout(() => poll(id, statusElem), 1000);
        }else if(data.status === 'done'){
            const stats = data.result.last_analysis_stats || {};
            const total = Object.values(stats).reduce((a,b)=>a+b,0);
            const mal = stats.malicious || 0;
            const tags = data.result.tags && data.result.tags.length ? ` <span class="icon"><i class="fas fa-tags"></i></span> ${data.result.tags.join(', ')}` : '';
            if(mal > 0) statusElem.dataset.malicious = 'true';
            statusElem.innerHTML = `<span class="icon has-text-success"><i class="fas fa-check"></i></span> rep ${data.result.reputation}, ${mal}/${total} detections${tags}`;
        }else if(data.status === 'error'){
            statusElem.innerHTML = `<span class="icon has-text-danger"><i class="fas fa-exclamation-triangle"></i></span> ${data.error || 'error'}`;
        }
    });
}

const toggle = document.getElementById('theme-toggle');
toggle.addEventListener('click', () => {
    document.body.classList.toggle('dark');
    const icon = toggle.querySelector('i');
    if(document.body.classList.contains('dark')){
        icon.classList.remove('fa-moon');
        icon.classList.add('fa-sun');
    } else {
        icon.classList.remove('fa-sun');
        icon.classList.add('fa-moon');
    }
});
</script>
</body>
</html>
